Experiments with co-ordinating C and Forth                                                                                      Copyright 1995 Frank Sergeant                                                                                                             frank@pygmy.utoh.org                                            http://pygmy.utoh.org                                                                                                 See license file license20040130.txt or                                   http://pygmy.utoh.org/license.html                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( Load block)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   2VARIABLE  creates a 4-byte variable that can hold a                       C "far pointer"                                                                                                                                                                      CTABLE     holds a seg offset (far pointer) address of the                 table in the C wrapper.  The table contains                     the far pointers to various C functions and                     variables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( Macros to make building a call to a C routine easy)                                                                           PUSH-ARGS,  is an assembler macro that lays down the code                   to move parameters from Forth's data stack                      to Forth's return stack.  When the C routine                    is called, Forth's return stack will be used as                 C's parameter stack.                                                                                                GET-RESULT, is an assembler macro that lays down the code                   to move the result (if any) returned by the                     C function from register AX or registers DX:AX                  to Forth's data stack.                                                                                                                                                                                                                                                                                                                                                              CDECL:                                                                                                                               This is a defining word that builds a CODE word to call    a C function.  The index is used at run time to look up the     address of the C function in a table in the C program (the      address of the table is stored in CTABLE).  The #in parameter   tells CDECL: how many 16-bit words to move from the data stack  to C's stack prior to calling the C function.  The #out         parameter tells CDECL: how many 16-bit words to move from AX or DX:AX to Forth's data stack after the C function returns.                                                                                                                                                                                                                                                                                                                                                                                                       CVAR:                                                                                                                                This is similar to CDECL: but is used for variables        instead of functions.  It defines a word that returns the       seg offset address of a C variable.  For example, if the 0th    item in the table is an integer j,                                                                                                    0 CVAR: J                                                                                                                 defines the Forth word J which will return the seg and offset   of the C integer j.  J L@ would return the current value of     that integer.  17 J L! would change the value to 17.                                                                                                                                                                                                            This block and the next define Forth words to access all of the variables and functions in the C program's pointers table.      These two blocks and the C program's pointers table must be keptsynchronized!                                                                                                                   J accesses the C integer j just to illustrate the mechanism.    The sample program displays the value of j upon termination.    You could play with setting it to different values in Forth,    then see what value C displays upon termination:                                                                                                                                                        17 J L!     0 #BYE                                              32 J L!     5 #BYE       etc.                                                                                                                                                                                                                                                                                           Perhaps the most important point to notice is that the Forth    stack comment shows the parameters in the very same order as    the C function prototypes.  If in C you would say                                                                                          circle (200, 300, 75);                                                                                               then in Forth you would say                                                                                                                200 300 75 circle                                                                                                    For more information about these particular graphic functions,  see Borland's BGI documentation.                                                                                                                                                                                                                                                                                                These are various examples of accessing the graphics functions  from Forth.  Try typing  TST1  to see them in action.                                                                           Note!  It is unlikely that your Borland graphic drivers are     on drive G: as mine are.  Be sure to change the path in the     definition of INIT-GPH before running these examples!                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           This block contains more examples of accessing the BGI graphics routines.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       