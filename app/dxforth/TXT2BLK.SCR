\ Information                                                                                                                   Convert ascii text files to forth screens                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ Load - main screen                                            empty forth definitions decimal application                     warning on                                                                                                                      : TITLE ." TXT2BLK version 1.2" cr ;                                                                                            cr ." Compiling: "  title  2 load                                                                                               cr ." Save to disk? "  y/n  [if]                                \  tally @  pad + #256 + limit s0 @ - +  set-limit                turnkey program TXT2BLK                                       [then]                                                                                                                                                                                                                                                                                                                          \ Load - defaults                                               variable TALLY  0 tally !           \ run-time memory tally     defer ?STOP   ' noop is ?stop       \ user abort check          defer CON-IO  ' bios-io is con-io   \ default console i/o mode  defer ONERROR ' noop is onerror     \ reset on-error handler    defer ONSTART ' noop is onstart     \ startup initialization                                                                    blk @ 1+ #screens 1- thru       \ load electives & application                                                                   ' ?stopkey is ?stop            \ enable user abort             \ ' dos-io is con-io             \ enable console redirection   \ ' deloutfile +is onerror       \ delete outfile on error      \ wrtchk off                     \ disable overwrite check                                                                                                                                                                                                      \ Electives                                                     1 fload DOSLIB  \ DOSLIB library                                                                                                 _Errors        \ error handler                                 \ _Inout1        \ number output                                \ _Inout2        \ number output                                \ _Compare1      \ basic compare                                 _String1       \ basic strings                                 \ _String2       \ extra strings                                 _Parsing1      \ command-line parsing                           _Parsing2      \ command-line parsing                           _Fileprims     \ file primitives                                _Files         \ default files                                 \ _Bufinfile     \ buffered input file                          \ _Bufoutfile    \ buffered output file                                                                                         \ Help screen - HELP                                            : HELP ( -- )  dos-io  cr cr title                                cr ." Use:  TXT2BLK [-opt] file[.LST] [file[.SCR]]" cr          cr ." -W    wrap lines"                                         cr ." -Cn   #cols[,rows[,size]]"                                cr ." -Rn   #rows"                                              cr ." -Bn   block size"                                         cr ." -P    page on empty '\' line"                             cr                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ Help screen - HELP                                              cr ." default: truncate lines, 64x16 screen"                    cr                                                              cr ." Convert ASCII text files to Forth screens."               con-io  abort ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ Variables                                                     variable WRAP       \ line wrap flag                            variable ROW        \ count                                     variable #TRUNC     \ count                                     variable PO         \ paging mode                                                                                               64   value #COLS    \ cols/screen                               16   value #ROWS    \ rows/screen                               1024 value BLKSIZ   \ block size                                                                                                : B/SCR  ( -- n )  #cols #rows * ;     \ logical screen size    : BUFSIZ ( -- n )  blksiz b/scr max ;  \ screen buffer size                                                                                                                                                                                                                                                                     \ SETCOLS                                                       \ Set #cols, #rows, block size                                  : SETCOLS ( a u -- a' 0 )                                         firstnum if  0 of  #cols   then  to #cols                       nextnum  if  0 of  #rows   then  to #rows                       nextnum  if  0 of  blksiz  then  to blksiz                      then then then ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \ SETOPTION                                                     \ Set options                                                   :noname ( a u char -- a' u' )                                     upcase                                                          [char] W  of  wrap on  end                                      [char] C  of  setcols  end                                      [char] R  of  /num to #rows  end                                [char] B  of  /num to blksiz  end                               [char] P  of  po on  end                                        badoption ;  is setoption                                                                                                                                                                                                                                                                                                                                                                                                                                     \ PARSEFILENAME                                                 \ Parse filenames                                               :noname ( -- )                                                    argv 0= if  help  then                                          s" LST" +ext  infile !fname                                     argv 0= if  infile @fname  -path -ext  then                     s" SCR" +ext  outfile !fname ;  is parsefilename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \ /ROWS ROW# GET CLEAN                                          \ Reset row counter                                             : /ROWS ( -- )  #rows row ! ;                                                                                                   \ Current row                                                   : ROW# ( -- n )  #rows  row @  - ;                                                                                              \ Read a line  false if EOF                                     : GET ( -- a u flag )                                             bufsiz ( for ultraForth)  pad +                                 #rows 4 *  ( avoid wrap gap on long lines)  readtext ;                                                                        \ Convert tabs, trim trailing spaces                            : CLEAN ( a u -- a u' )  2dup >blanks  -trailing ;                                                                                                                                              \ ?TRUNC WRTBLK PUT PADSCR                                      \ Truncate line                                                 : ?TRUNC ( a u -- a u' )                                          wrap @ if end  #cols  2dup > if  1 #trunc +!  then  min ;                                                                     \ Write block                                                   : WRTBLK ( -- )  pad blksiz writedata  /rows ;                                                                                  : PUT ( a u -- )                                                  row @  0= if  wrtblk  then                                      row# #cols *  pad +  dup #cols blank  swap cmove  -1 row +! ;                                                                 \ Pad remainder of screen with blanks                           : PADSCR ( -- )                                                   row# if  row @  0 ?do  here 0 put  loop  wrtblk  then ;                                                                       \ PAGE? PROCLINE                                                \ Test for sentinel                                             : PAGE? ( a u -- flag )                                           1 =  swap c@ [char] \ =  and  po @ and ;                                                                                      \ Process a line                                                : PROCLINE ( a u -- )                                             2dup page? if  \ new scr                                          padscr                                                        else                                                              clean  ?trunc  ( a u)                                           begin  #cols over min  /split  put  dup 0= until              then 2drop ;                                                                                                                                                                                                                                                  \ .TRUNC COPYFILE                                               \ Notify any truncated lines                                    : .TRUNC ( -- )  #trunc @  ?dup                                   if  cr ." Warning - " u. ." lines truncated" cr  then ;                                                                       \ Copy loop                                                     : COPYFILE ( -- )                                                 /rows  #trunc off                                               begin  get while  procline  repeat 2drop  padscr                .trunc ;                                                                                                                                                                                                                                                                                                                                                                                                                                                      \ (RUN)                                                         \ Run application                                               : (RUN) ( -- )                                                    cr ." infile:  "  infile .fname  r/o openinfile                 cr ." outfile: "  outfile .fname  r/w makeoutfile               cr ( perform the application tasks )                            copyfile                                                        closefiles                                                    ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ DEFAULTS                                                      \ Set application defaults                                      : DEFAULTS ( -- )                                                 wrap off  64 to #cols  16 to #rows  1024 to blksiz  po off    ;                                                                                                                               defaults                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ RUN PROGRAM                                                   \ Run application with error handling                           : RUN ( -- )                                                      ['] (run) catch ?dup if  >r onerror r> throw  then ;                                                                          \ Main                                                          : PROGRAM ( -- )                                                  onstart           \ startup initialization                      con-io            \ default console mode                        defaults          \ set defaults                                cr title          \ show application name                       cmdtail parsecmd  \ process command-line                        run               \ run application                             cr ." done"       \ show success                              ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               