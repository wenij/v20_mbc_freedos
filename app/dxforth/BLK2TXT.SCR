\ Information                                                                                                                   Convert forth screen files to ascii text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ Load - main screen                                            empty forth definitions decimal application                     warning on                                                                                                                      : TITLE ." BLK2TXT version 1.2" cr ;                                                                                            cr ." Compiling: "  title  2 load                                                                                               cr ." Save to disk? "  y/n  [if]                                \  tally @  pad + #256 + limit s0 @ - +  set-limit                turnkey program BLK2TXT                                       [then]                                                                                                                                                                                                                                                                                                                          \ Load - defaults                                               variable TALLY  0 tally !           \ run-time memory tally     defer ?STOP   ' noop is ?stop       \ user abort check          defer CON-IO  ' bios-io is con-io   \ default console i/o mode  defer ONERROR ' noop is onerror     \ reset on-error handler    defer ONSTART ' noop is onstart     \ startup initialization                                                                    blk @ 1+ #screens 1- thru       \ load electives & application                                                                   ' ?stopkey is ?stop            \ enable user abort             \ ' dos-io is con-io             \ enable console redirection   \ ' deloutfile +is onerror       \ delete outfile on error      \ wrtchk off                     \ disable overwrite check                                                                                                                                                                                                      \ Electives                                                     1 fload DOSLIB  \ DOSLIB library                                                                                                 _Errors        \ error handler                                 \ _Inout1        \ number output                                \ _Inout2        \ number output                                \ _Compare1      \ basic compare                                 _String1       \ basic strings                                 \ _String2       \ extra strings                                 _Parsing1      \ command-line parsing                           _Parsing2      \ command-line parsing                           _Fileprims     \ file primitives                                _Files         \ default files                                 \ _Bufinfile     \ buffered input file                          \ _Bufoutfile    \ buffered output file                                                                                         \ Help screen - HELP                                            : HELP ( -- )  dos-io  cr cr title                                cr ." Use:  BLK2TXT [-opt] file[.SCR] [file[.LST]]" cr          cr ." -F[n] formatted [offset]"                                 cr ." -Cn   #cols[,rows[,size]]"                                cr ." -Rn   #rows"                                              cr ." -Bn   block size"                                         cr                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ Help screen - HELP                                              cr ." default: unformatted, 64x16 screen"                       cr                                                              cr ." Convert Forth screen files to ASCII text."                con-io  abort ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ Variables                                                     variable FMT        \ formatted flag                            variable ROW        \ count                                     variable SCREEN     \ count                                                                                                     0    value #OFFS    \ screen offset to print                    64   value #COLS    \ cols/screen                               16   value #ROWS    \ rows/screen                               1024 value BLKSIZ   \ block size                                                                                                : B/SCR  ( -- n )  #cols #rows * ;     \ logical screen size    : BUFSIZ ( -- n )  blksiz b/scr max ;  \ screen buffer size                                                                                                                                                                                                                                                                     \ SETCOLS SETFMT                                                \ Set #cols, #rows, block size                                  : SETCOLS ( a u -- a' 0 )                                         firstnum if  0 of  #cols   then  to #cols                       nextnum  if  0 of  #rows   then  to #rows                       nextnum  if  0 of  blksiz  then  to blksiz                      then then then ;                                                                                                              : SETFMT ( a u -- a' 0 )                                          firstnum if  to #offs  then  fmt on ;                                                                                                                                                                                                                                                                                                                                                                                                                         \ SETOPTION                                                     \ Set options                                                   :noname ( a u char -- a' u' )                                     upcase                                                          [char] F  of  setfmt  end                                       [char] C  of  setcols  end                                      [char] R  of  /num to #rows  end                                [char] B  of  /num to blksiz  end                               badoption ;  is setoption                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ PARSEFILENAME                                                 \ Parse filenames                                               :noname ( -- )                                                    argv 0= if  help  then                                          s" SCR" +ext  infile !fname                                     argv 0= if  infile @fname  -path -ext  then                     s" LST" +ext  outfile !fname ;  is parsefilename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \ /ROWS WRITE IDX PUT                                           \ Reset row counter                                             : /ROWS ( -- )  #rows row ! ;                                                                                                   aka writedata WRITE ( adr len -- )                                                                                              \ Write screen/line numbering                                   : IDX ( -- )                                                      row @  dup 0= if  \ new screen                                    (cr) write  s"    " write                                       screen @  #offs +  (u.) write  (cr) write                     then  (u.) 2 (s.r) write  s"  " write  ;                                                                                      \ Write a line                                                  : PUT ( a u -- )                                                  fmt @ if idx then  write  (cr) write  1 row +! ;              \ GETBLK GET COPYFILE                                           \ Read next block                                               : GETBLK ( flag -- flag' )                                        pad  dup bufsiz blank  ( for ultraForth)                        blksiz readdata  nip 0<> and  1 screen +! ;                                                                                   \ Get next line                                                 : GET ( -- a u flag )                                             true  row @  #rows  of  getblk  0  then  dup row !              #cols *  pad +  #cols  -trailing  rot ;                                                                                       \ Copy loop                                                     : COPYFILE ( -- )                                                 /rows  -1 screen !                                              begin  get while  put  repeat 2drop ;                                                                                         \ (RUN)                                                         \ Run application                                               : (RUN) ( -- )                                                    cr ." infile:  "  infile .fname  r/o openinfile                 cr ." outfile: "  outfile .fname  r/w makeoutfile               cr ( perform the application tasks )                            copyfile                                                        closefiles                                                    ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ DEFAULTS                                                      \ Set application defaults                                      : DEFAULTS ( -- )                                                 64 to #cols  16 to #rows  1024 to blksiz  fmt off             ;                                                                                                                               defaults                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ RUN PROGRAM                                                   \ Run application with error handling                           : RUN ( -- )                                                      ['] (run) catch ?dup if  >r onerror r> throw  then ;                                                                          \ Main                                                          : PROGRAM ( -- )                                                  onstart           \ startup initialization                      con-io            \ default console mode                        defaults          \ set defaults                                cr title          \ show application name                       cmdtail parsecmd  \ process command-line                        run               \ run application                             cr ." done"       \ show success                              ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               